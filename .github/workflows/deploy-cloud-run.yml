name: Build and Deploy to Cloud Run

on:
  push:
    branches:
      - main
      - development
  pull_request:
    branches:
      - main
      - development

env:
  GCP_PROJECT_ID: nexo-dev-465520
  GCP_REGION: us-central1

jobs:
  build-and-test:
    name: Build, Lint and Type-Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build
        env:
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          NEXT_PUBLIC_CLERK_SIGN_IN_URL: /auth/sign-in
          NEXT_PUBLIC_CLERK_SIGN_UP_URL: /auth/sign-up
          NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL: /dashboard/overview
          NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL: /dashboard/overview
          NEXT_PUBLIC_SENTRY_DISABLED: "true"

      - name: Lint
        run: pnpm lint
        env:
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}

      - name: Type-Check
        run: pnpm exec tsc --noEmit
        env:
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}

  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push'
    strategy:
      matrix:
        include:
          - branch: main
            env_name: production
            service_name: nexo-intranet-app-prod
            cloud_sql_instance: nexo-dev-465520:us-central1:nexo-intranet-prod
          - branch: development
            env_name: development
            service_name: nexo-intranet-app-dev
            cloud_sql_instance: nexo-dev-465520:us-central1:nexo-intranet-dev
    environment: ${{ matrix.env_name }}
    continue-on-error: true
    
    steps:
      - name: Check if branch matches
        run: |
          if [ "${{ github.ref }}" != "refs/heads/${{ matrix.branch }}" ]; then
            echo "Skipping deployment - branch mismatch (expected: ${{ matrix.branch }}, got: ${{ github.ref }})"
            exit 0
          fi
      
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Create cloudrun-env.yaml from secrets
        run: |
          cat > cloudrun-env.yaml << EOF
          DATABASE_URL: "${{ secrets.DATABASE_URL }}"
          CLERK_SECRET_KEY: "${{ secrets.CLERK_SECRET_KEY }}"
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: "${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}"
          NEXT_PUBLIC_CLERK_SIGN_IN_URL: "/auth/sign-in"
          NEXT_PUBLIC_CLERK_SIGN_UP_URL: "/auth/sign-up"
          NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL: "/dashboard/overview"
          NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL: "/dashboard/overview"
          NEXT_PUBLIC_SENTRY_DISABLED: "true"
          EOF

      - name: Deploy to Cloud Run (${{ matrix.env_name }})
        run: |
          gcloud run deploy ${{ matrix.service_name }} \
            --region=${{ env.GCP_REGION }} \
            --source=. \
            --service-account=intranet-service-account@nexo-dev-465520.iam.gserviceaccount.com \
            --allow-unauthenticated \
            --add-cloudsql-instances=${{ matrix.cloud_sql_instance }} \
            --set-build-env-vars="NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }},NEXT_PUBLIC_CLERK_SIGN_IN_URL=/auth/sign-in,NEXT_PUBLIC_CLERK_SIGN_UP_URL=/auth/sign-up,NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/dashboard/overview,NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/dashboard/overview" \
            --env-vars-file=cloudrun-env.yaml \
            --project=${{ env.GCP_PROJECT_ID }}

